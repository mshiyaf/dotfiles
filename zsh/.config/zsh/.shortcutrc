# vim: filetype=zsh


# Setup fzf
# ---------
source <(fzf --zsh)


t_s(){
    ~/code/dotfiles/zsh/.config/zsh/tmux-sessionizer.sh
}

zle -N fzf-file-widget

bindkey -s '^f' 't_s\n'
bindkey -M vicmd '\ef' fzf-file-widget
bindkey -M viins '\ef' fzf-file-widget

bindkey '^l' autosuggest-accept
bindkey '\e[A' history-beginning-search-backward
bindkey '\e[B' history-beginning-search-forward
# bindkey '^o' up-line-or-history

function mkcd() { mkdir -p "$@" && cd "$_"; }

encrypt_secrets() {
    local plain="${HOME}/secrets.env"
    local crypt="${HOME}/.config/zsh/secrets.gpg.env"

    if [[ ! -f "$plain" ]]; then
        echo "âŒ Plain secrets file not found: $plain"
        return 1
    fi

    # Get fingerprint directly
    local fingerprint=$(gpg --list-keys --with-colons --fingerprint | awk -F: '$1=="fpr" {print $10; exit}')
    
    if [[ -z "$fingerprint" ]]; then
        echo "âŒ No GPG fingerprint found"
        return 1
    fi

    echo "Found fingerprint: $fingerprint"
    
    # Get the user ID for display
    local uid=$(gpg --list-keys --with-colons | awk -F: '$1=="uid" {print $10; exit}')
    echo "For key: $uid"

    if [[ -f "$crypt" ]]; then
        if [[ -n "$ZSH_VERSION" ]]; then
            read "ans?Overwrite existing encrypted file? [y/N] "
        else
            read -p "Overwrite existing encrypted file? [y/N] " ans
        fi
        [[ "$ans" =~ ^[Yy] ]] || return 0
    fi

    # Try sops encryption
    echo "Encrypting with sops..."
    if sops --encrypt --pgp "$fingerprint" --output "$crypt" "$plain"; then
        chmod 600 "$crypt"
        echo "âœ… Secrets encrypted to: $crypt"
    else
        echo "âŒ sops failed. Trying alternative approaches..."
        
        # Try with SOPS_PGP_FP environment variable
        echo "Trying with environment variable..."
        if SOPS_PGP_FP="$fingerprint" sops --encrypt --output "$crypt" "$plain"; then
            chmod 600 "$crypt"
            echo "âœ… Secrets encrypted to: $crypt"
        else
            echo "âŒ All encryption attempts failed"
            echo "ðŸ’¡ You may need to create ~/.sops.yaml with:"
            echo "creation_rules:"
            echo "  - pgp: '$fingerprint'"
            return 1
        fi
    fi
}
